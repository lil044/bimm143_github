---
title: "Lab 18: Pertussis Mini Project"
author: "Jessica Le (PID: A17321021)"
format: html
---

Pertussis (a.k.a. whooping cough) is a deadly lung infection caused by the bacteria B. Pertussis. 

The CDC tracks Pertussis cases around the US. 
http://tinyurl.com/pertussiscdc

We can "scrape" this data using the R **datapasta** package. 

```{r, include=FALSE}
cdc <- data.frame(
  year = c(1922L,1923L,1924L,1925L,
           1926L,1927L,1928L,1929L,1930L,1931L,
           1932L,1933L,1934L,1935L,1936L,
           1937L,1938L,1939L,1940L,1941L,1942L,
           1943L,1944L,1945L,1946L,1947L,
           1948L,1949L,1950L,1951L,1952L,
           1953L,1954L,1955L,1956L,1957L,1958L,
           1959L,1960L,1961L,1962L,1963L,
           1964L,1965L,1966L,1967L,1968L,1969L,
           1970L,1971L,1972L,1973L,1974L,
           1975L,1976L,1977L,1978L,1979L,1980L,
           1981L,1982L,1983L,1984L,1985L,
           1986L,1987L,1988L,1989L,1990L,
           1991L,1992L,1993L,1994L,1995L,1996L,
           1997L,1998L,1999L,2000L,2001L,
           2002L,2003L,2004L,2005L,2006L,2007L,
           2008L,2009L,2010L,2011L,2012L,
           2013L,2014L,2015L,2016L,2017L,2018L,
           2019L,2020L,2021L,2022L, 2024L),
  cases = c(107473,164191,165418,152003,
                                   202210,181411,161799,197371,
                                   166914,172559,215343,179135,265269,
                                   180518,147237,214652,227319,103188,
                                   183866,222202,191383,191890,109873,
                                   133792,109860,156517,74715,69479,
                                   120718,68687,45030,37129,60886,
                                   62786,31732,28295,32148,40005,
                                   14809,11468,17749,17135,13005,6799,
                                   7717,9718,4810,3285,4249,3036,
                                   3287,1759,2402,1738,1010,2177,2063,
                                   1623,1730,1248,1895,2463,2276,
                                   3589,4195,2823,3450,4157,4570,
                                   2719,4083,6586,4617,5137,7796,6564,
                                   7405,7298,7867,7580,9771,11647,
                                   25827,25616,15632,10454,13278,
                                   16858,27550,18719,48277,28639,32971,
                                   20762,17972,18975,15609,18617,
                                   6124,2116,3044, 35493)
)
```

```{r}
head(cdc)
```

> Q1. With the help of the R “addin” package datapasta assign the CDC pertussis case number data to a data frame called cdc and use ggplot to make a plot of cases numbers over time.


```{r}
library(ggplot2)

ggplot(cdc) +
  aes(year, cases) +
  geom_line() + 
  labs(title="Pertussis Cases by Year (1922-2024)", x="Year", y="Number of Reported Pertussis Cases")
```

> Q2. Using the ggplot geom_vline() function add lines to your previous plot for the 1946 introduction of the wP vaccine and the 1996 switch to aP vaccine (see example in the hint below). What do you notice?

```{r}
ggplot(cdc) +
  aes(year, cases) +
  geom_line() + 
  geom_vline(xintercept = 1946, col="blue") + 
  geom_vline(xintercept = 1996, col="purple") +
  geom_vline(xintercept=2020, col="pink") +
  geom_vline(xintercept=2003, col="darkgreen") +
  labs(title="Pertussis Cases by Year (1922-2024)", x="Year", y="Number of Reported Pertussis Cases")
```
There were high cases numbers before the first wP (whole-cell) vaccine roll out in 1946 where a rapid decline in cases numbers is observed until 2004 when we have our first large-scale outbreaks of pertussis again. There is also notable COVID decrease in the number of reported outbreaks, and a recent rapid rise in cases has been reported in the recent years. 

> Q3. Describe what happened after the introduction of the aP vaccine? Do you have a possible explanation for the observed trend?

There appears to be an increase in the number of reported pertussis cases after the introduction of the aP vaccine. A possible explanation includes the pertussis bacteria evolving to become resistant to the vaccine; therefore, vaccination is not helping to reduce the number of reported cases since people can still be infected due to the resistant bacteria. 

## Computational Models of Immunity Pertussis Boost (CMI-PB)

> Q. What is different about the immune response to infection if you had an older wP vaccine vs the newer aP vaccine?

No definitive answer can be provided right now regarding the difference in immune response to infection between the different vaccines. 

The CMI-PB project aims to address this key question: what is different between aP and wP individuals. 

We can get all the data from this ongoing project via JSON API calls. 
For this we will use the **jsonlite** package. 

```{r}
library(jsonlite)
subject <- read_json("https://www.cmi-pb.org/api/v5_1/subject", 
                     simplifyVector = TRUE)

head(subject)

```

> Q. How many individuals "subjects" are in this dataset? 

```{r}
nrow(subject)
```

> Q4. How many wP and aP primmed individuals are in this dataset? 

```{r}
table(subject$infancy_vac)
```

> Q5. How many Male and Female subjects/patients are in the dataset? 

```{r}
table(subject$biological_sex)
```

> Q6. What is the breakdown of race and biological sex (e.g. number of Asian females, White males etc…)?

```{r}
table(subject$race, subject$biological_sex)
```

This is not representative of the US population but it is the biggest dataset of its type so let's see what we can learn... 

# Side-Note: Working with dates 

```{r}
library(lubridate)
```

Today's date is...
```{r}
today()
```
The number of days that have passed since new year 2000...
```{r}
today() - ymd("2000-01-01")
```

The time difference of 9198 days in years is...
```{r}
time_length(today()-ymd("2000-01-01"), "years")
```

> Q7. Determine (i) the average age of wP individuals, (ii) the average age of aP individuals; and (iii) are they significantly different?

Use dplyr’s filter() function to limit ourselves to a particular subset of subjects to examine the 6 number summary of their age in years:

```{r}
# Use todays date to calculate age in days
subject$age <- today() - ymd(subject$year_of_birth)
subject$age
```

```{r}
library(dplyr)

#aP
ap <- subject %>% filter(infancy_vac == "aP")

round(summary( time_length( ap$age, "years" ) ) )
```

```{r}
# wP
wp <- subject %>% filter(infancy_vac == "wP")
round( summary( time_length( wp$age, "years" ) ) )
```
The average age of aP individuals is 27 and 36 for wP individuals. The difference in their average age is 9 and does appear to be significantly different. 

> Q8. Determine the age of all individuals at time of boost. 

```{r}
int <- ymd(subject$date_of_boost) - ymd(subject$year_of_birth)
age_at_boost <- time_length(int, "year")
head(age_at_boost)
```

> Q9. With the help of a faceted boxplot or histogram, do you think these two groups are significantly different?

```{r}
ggplot(subject) +
  aes(time_length(age, "year"),
      fill=as.factor(infancy_vac)) +
  geom_histogram(show.legend=FALSE) +
  facet_wrap(vars(infancy_vac), nrow=2) +
  xlab("Age in years")
```

Yes, average age of the wP and aP individuals does appear different in the histograms. We can confirm whether or not they are statisticaly significant by calculating a p-value. 

```{r}
x <- t.test(time_length( wp$age, "years" ),
       time_length( ap$age, "years" ))

x$p.value
```

Because the calculated p-value is less than 0.05, it can be concluded that the average age between wP and aP individuals are statistically significant. 

# Joining multiple tables

Obtain more data from CMI-PB to explore more about the data...

```{r}
specimen <- read_json("https://www.cmi-pb.org/api/v5_1/specimen",
                       simplifyVector=T)
ab_data <- read_json("https://www.cmi-pb.org/api/v5_1/plasma_ab_titer", 
                       simplifyVector=T)
```

```{r}
head(specimen)
```

```{r}
head(ab_data)
```

I now have 3 tables of data from CMI-PB: `subject`, `specimen`, and `ab_data`. I need to "join" these tables so I will have all the info I need to work with. 

For this we will use the `inner_join()` function from the **dplyr** package. 

> Q9. Complete the code to join specimen and subject tables to make a new merged data frame containing all specimen records along with their associated subject details:

```{r}
library(dplyr)

meta <-  inner_join(subject, specimen)
head(meta)
```

```{r}
dim(subject)
dim(specimen)
```

```{r}
dim(meta)
```

Now we can join our `ab_data` table to `meta` so we have all the info we need about antibody levels. 

> Q10. Now using the same procedure join meta with titer data so we can further analyze this data in terms of time of visit aP/wP, male/female etc.

```{r}
abdata <- inner_join(meta, ab_data)
head(abdata)
```

> Q. How many different antibody isotypes are there in this dataset? 

```{r}
length(abdata$isotype)
```
There are 61956 total different antibody istoypes in the dataset.  

> Q11. How many specimens (i.e. entries in abdata) do we have for each isotype?

To find the amount of each antibody isotype: 
```{r}
table(abdata$isotype)
```

> Q12. What are the different $dataset values in `abdata` and what do you notice about the number of rows for the most "recent" dataset? 

```{r}
table(abdata$dataset)
```
The number of rows for the most recent dataset of 2023 has significantly increased compared to the previous decrease in the years of 2021 and 2022 from 2020. 

> Q. How many different antigens are in this dataset? 

```{r}
table(abdata$antigen)
```

I want a plot of antigen levels across the whole dataset. 

```{r}
ggplot(abdata) + 
  aes(MFI, antigen) + 
  geom_boxplot()
```

```{r}
ggplot(abdata) + 
  aes(MFI_normalised, antigen) + 
  geom_boxplot()
```

Antigens like FIM2/3, PT, and FELD1 have quite a large range of values. Others like Measles don't show much activity. Antigens with high range of values are those present in either the wP or aP vaccine. 

> Q. Are there differences at this whole-dataset level between aP and wP? 

```{r}
ggplot(abdata) + 
  aes(MFI_normalised, antigen, col=infancy_vac) + 
  geom_boxplot()
```

```{r}
ggplot(abdata) + 
  aes(MFI_normalised, antigen) + 
  geom_boxplot() + 
  facet_wrap(~infancy_vac)
```

## Examine IgG Ab titer levels

For this I need to select out just isotype IgG. 

```{r}
igg <- abdata %>% filter(isotype == "IgG")
head(igg)
```

An overview boxplot: 

```{r}
ggplot(igg) + 
  aes(MFI_normalised, antigen, col=infancy_vac) + 
  geom_boxplot()
```
> Q13. Complete the following code to make a summary boxplot of Ab titer levels (MFI) for all antigens:

```{r}
ggplot(igg) +
  aes(MFI_normalised, antigen) +
  geom_boxplot() + 
    xlim(0,75) +
  facet_wrap(vars(visit), nrow=2)
```

> Q14. What antigens show differences in the level of IgG antibody titers recognizing them over time? Why these and not others?

FIM2/3, PT, and FHA are antigens that show differences in the level of IgG antibody titers recognizing them over time. They are components of the pertussis vaccine; therefore, will have different levels of IgG antibody titers recognition over time as they will attempt to provide protection against the different strains of pertussis that evolve over time. 

Digging in further to look at the time course of IgG isotype PT antigen levels accross aP and wP individuals: 

```{r}
## Filter to include 2021 data only
abdata.21 <- abdata %>% filter(dataset == "2021_dataset")

## Filter to look at IgG PT data only
pt.igg <- abdata.21 %>% 
  filter(isotype == "IgG",  antigen == "PT") 
  
## Plot and color by infancy_vac (wP vs aP)
ggplot(pt.igg) +
    aes(x=planned_day_relative_to_boost,
        y=MFI_normalised,
        col=infancy_vac,
        group=subject_id) +
    geom_point() +
    geom_line() +
    geom_vline(xintercept=0, linetype="dashed") +
    geom_vline(xintercept=14, linetype="dashed") +
  labs(title="2021 dataset IgG PT",
       subtitle = "Dashed lines indicate day 0 (pre-boost) and 14 (apparent peak levels)")
```


